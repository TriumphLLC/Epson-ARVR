b4w.register("AR_main",function(Z,e){function aa(b,a){a?(L.create_preloader(),b.oncontextmenu=function(a){a.preventDefault();a.stopPropagation();return!1},ba.load(C+"AR.json",ca,da)):console.log("b4w init failure")}function da(b){L.update_preloader(b)}function ca(b,a){navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(M)["catch"](D):D(Error("WebRTC: It seems WebRTC is not supported on your device."));var c=x.get_container();c.addEventListener("click",function(){ea.request_fullscreen(c)});
document.getElementById("switch_video").addEventListener("click",function(){var a=!0,b=document.getElementById("v");return function(){a=!a;b.style.display=a?"":"none";N(!a)}}());document.querySelector(".control").style.display=E.is_ie11()?"block":"grid";if(a){O.enable_camera_controls();fa();k={front:f.get_object_by_name("orbits_front"),back:f.get_object_by_name("orbits_back"),start_scale:1,start_time:-Infinity};ga();var e=m.create_mouse_click_sensor(),ia=m.create_touch_click_sensor(),g=m.create_timeline_sensor();
m.create_sensor_manifold(null,"TRIG_ANIMATION",m.CT_SHOT,[e,ia,g],function(a){return a[0]||a[1]},function(a,b,c){var d=m.get_sensor_value(a,b,0),y=m.get_sensor_value(a,b,1);c=m.get_sensor_value(a,b,2);if(d||y)if(a=d?m.get_sensor_payload(a,b,0):m.get_sensor_payload(a,b,1),a=x.client_to_canvas_coords(a.coords[0],a.coords[1],ja),a=f.pick_object(a[0],a[1])){a:{for(b=0;b<p.length;b++)if(d=p[b],d.geom===a){b=d;break a}b=null}if(b)for(t=b.focused?!1:!0,n.start_time=c,b=h.get_translation_rel(n.geom,q),n.start_trans_length=
l.length(b),k.start_time=c,k.start_scale=h.get_scale(k.front),b=0;b<p.length;b++)d=p[b],y=h.get_translation_rel(d.armature,q),t?(l.copy(y,d.original_trans),d.focused=d.geom==a?!0:!1):d.focused=!1,d.start_scale=h.get_scale(d.armature),d.start_time=c,d.start_trans_length=l.length(y)}});g=m.create_timeline_sensor();m.create_sensor_manifold(null,"ANIMATION",m.CT_POSITIVE,[g],null,function(a,b,d){a=m.get_sensor_value(a,b,0);d=a-n.start_time;1>=d&&(b=l.copy(E.AXIS_X,q),d=t?r.ease_out_expo(d,n.start_trans_length,
50,1):r.ease_out_expo(d,n.start_trans_length,-n.start_trans_length,1),b=l.scale(b,d,q),b=l.add(b,n.origin_trans,b),h.set_translation_rel_v(n.geom,b),h.set_translation_rel_v(n.crown_geom,b),h.set_translation_rel_v(n.lamp,b));t&&(F=!1);for(b=0;b<p.length;b++){d=p[b];var c=a-d.start_time;if(1>=c){var e,g;if(t)d.focused?(e=r.ease_out_bounce(c,d.start_scale,20/(ka[d.name]*G[d.name]),1),c=r.ease_out_expo(c,d.start_trans_length,-d.start_trans_length,1)):(e=r.ease_in_circ(c,d.start_scale,-d.start_scale,1),
c=r.ease_in_expo(c,d.start_trans_length,500,1)),g=l.normalize(d.original_trans,q),g=l.scale(g,c,q),P.stop(d.empty);else{e=r.ease_out_expo(c,d.start_scale,G[d.name]-d.start_scale,1);g=l.normalize(d.original_trans,q);var ha=l.length(d.original_trans),c=r.ease_out_expo(c,d.start_trans_length,ha-d.start_trans_length,1);g=l.scale(g,c,q)}h.set_translation_rel_v(d.armature,g);h.set_scale(d.armature,e)}else if(t)for(b=0;b<p.length;b++)d=p[b],d.focused||h.set_scale(d.armature,0);else if(!F)for(b=0;b<p.length;b++)d=
p[b],h.set_translation_rel_v(d.armature,d.original_trans),P.play(d.empty),F=!0}a-=k.start_time;1>=a?(t?a=r.ease_in_expo(a,k.start_scale,50,1):(f.is_hidden(k.front)&&(f.show_object(k.front),f.show_object(k.back)),a=r.ease_out_expo(a,k.start_scale,1-k.start_scale,1)),h.set_scale(k.front,a),h.set_scale(k.back,a)):t?f.is_hidden(k.front)||(f.hide_object(k.front),f.hide_object(k.back)):(h.set_scale(k.front,1),h.set_scale(k.back,1))})}else console.log("b4w load failure")}function ga(){var b=f.get_object_by_name("Sun_geom");
n={geom:f.get_object_by_name("Sun_geom"),crown_geom:f.get_object_by_name("Sun_crown_geom"),lamp:f.get_object_by_name("Lamp"),start_time:-Infinity,start_trans_length:0,origin_trans:h.get_translation_rel(b,new Float32Array(3))}}function fa(){for(var b=0;b<Q.length;b++){var a;a=Q[b];a={name:a,empty:f.get_object_by_name(a+"_Emty"),geom:f.get_object_by_name(a+"_geom"),empty_action:a+"_EmtyAction",geom_action:a+"_ArmatureAction",armature:f.get_object_by_name(a+"_Armature"),focused:!1,start_time:-Infinity,
start_scale:1,original_trans:new Float32Array(3),start_trans_length:1};h.set_scale(a.armature,G[a.name]);p.push(a)}}function M(b){for(var a=document.querySelector("select#video_source");a.firstChild;)a.removeChild(a.firstChild);if(!b.length)throw Error("Camera devices are unavailable. Try to plug in your Web camera. If the camera is actually present, try closing any other tabs which use the camera, and reboot the current tab.");for(var c=0;c!==b.length;++c){var e=b[c];if("videoinput"===e.kind){var f=
document.createElement("option");f.value=e.deviceId;f.text=e.label||"Camera "+(a.length+1);a.appendChild(f)}}H.set_render_callback(la)}function D(b){var a=f.get_active_camera();R.target_setup(a,{pos:ma,pivot:S,use_panning:!0});window.removeEventListener("resize",I);window.addEventListener("resize",T);T();a=f.get_object_by_name("Empty");f.show_object(a);h.set_translation_v(a,S);H.clear_render_callback();if(a=document.getElementById("error"))a.style.display=E.is_ie11()?"block":"grid","DevicesNotFoundError"==
b.name?a.textContent="Camera devices are unavailable. Try to plug in your Web camera. If the camera is actually present, try closing any other tabs which use the camera, and reboot the current tab.":"TrackStartError"==b.name?(a.textContent="Media devices are unavailable.",a.textContent+=" Try to close another program using Web camera."):a.textContent="Error: "+b.name+" "+b.message}function na(b){window.stream=b;z.srcObject=b;return navigator.mediaDevices.enumerateDevices()}function U(){window.stream&&
window.stream.getTracks().forEach(function(a){a.stop()});var b=document.querySelector("select#video_source");b.onchange=U;b=b.value;navigator.mediaDevices.getUserMedia({video:{deviceId:b?{exact:b}:void 0}}).then(na).then(M).then(V)["catch"](D)}function la(){V();window.addEventListener("resize",I);z||(z=document.getElementById("v"),U());var b=f.get_object_by_name("Empty");g.detectMarker(z);if(0<g.getMarkerNum())if(-Infinity===A)A=performance.now();else{if(100<performance.now()-A){J?(g.getTransMatSquareCont(0,
1,v,v),f.is_hidden(b)&&f.show_object(b)):g.getTransMatSquare(0,1,v);g.getTransMatSquare(0,1,v);var a=g.transMatToGLMat(v,w);if(H.detect_mobile()&&-1<navigator.userAgent.indexOf("Firefox")){var c=w;c[0]=a[0];c[1]=-a[1];c[2]=a[2];c[3]=a[3];c[4]=-a[4];c[5]=a[5];c[6]=-a[6];c[7]=-a[7];c[8]=a[8];c[9]=-a[9];c[10]=a[10];c[11]=a[11];c[12]=a[12];c[13]=-a[13];c[14]=a[14];c[15]=a[15];a=c}c=u.fromXRotation(-Math.PI,oa);a=u.multiply(c,a,w);a=B.from_mat4(a,pa);c=B.get_trans_view(a,q);c=l.scale(c,20,q);B.set_trans(c,
a);h.set_tsr(b,a);J=!0}}else f.hide_object(b),J=!1,A=-Infinity}function V(){g&&(I(),W||(N(!1),W=!0))}function N(b){X=g.getCameraMatrix();var a=f.get_active_camera(),c=u.fromXRotation(-Math.PI,w),c=u.multiply(X,c,w);if(b){var e=u.invert(c,new Float32Array(16));b=l.transformMat4([-1,-1,-1],e,[]);c=l.transformMat4([1,1,-1],e,[]);e=l.transformMat4([1,1,1],e,[]);c=u.frustum(.5*b[0],.5*c[0],.5*b[1],.5*c[1],-b[2],-e[2],[])}R.set_projection(a,c)}function T(){x.resize_to_container(!0)}function I(){var b=document.getElementById("v"),
a=x.get_canvas();if(b&&a){var c=window.innerWidth,e=window.innerHeight,f=b.videoWidth/b.videoHeight;c/e<f?(f*=e,a.style.width=f+"px",a.style.marginLeft=-(f-c)/2+"px",a.style.height=e+"px",a.style.marginTop="0px"):(f=1/(f/c),a.style.height=f+"px",a.style.marginTop=-(f-e)/2+"px",a.style.width=c+"px",a.style.marginLeft="0px");b.style.width=a.style.width;b.style.height=a.style.height;b.style.marginLeft=a.style.marginLeft;b.style.marginTop=a.style.marginTop}}var P=e("animation"),O=e("app"),R=e("camera"),
qa=e("config"),x=e("container"),m=e("controls"),ba=e("data"),H=e("main"),u=e("mat4"),r=e("math"),L=e("preloader"),B=e("tsr"),f=e("scenes"),ea=e("screen"),h=e("transform"),E=e("util"),ra=e("version"),l=e("vec3");e("vec4");var pa=B.create(),ja=new Float32Array(2),q=l.create(),v=new Float64Array(12),w=new Float32Array(16),oa=new Float32Array(16),S=new Float32Array([0,0,0]),ma=new Float32Array([30,30,30]),Y="DEBUG"==ra.type(),C=qa.get_std_assets_path()+"AR/",g=null,z=null,J=!1,A=-Infinity,W=!1,Q="Earth Jupiter Mars Mercury Neptune Saturn Uranus Venus".split(" "),
ka={Mercury:.964,Venus:1.845,Earth:2,Mars:1.374,Jupiter:8.439,Saturn:5.539,Uranus:3.986,Neptune:3.995},G={Mercury:2,Venus:1.5,Earth:1.5,Mars:1.7,Jupiter:1,Saturn:1,Uranus:1,Neptune:1},p=[],t=!1,n=null,k=null,F=!0;Z.init=function(){O.init({canvas_container_id:"main_canvas_container",callback:aa,show_fps:Y,console_verbose:Y,autoresize:!1})};var K=new ARCameraParam,X=null;K.onload=function(){g=new ARController(320,240,K);g.setThreshold(100);g.setPatternDetectionMode(artoolkit.AR_MARKER_INFO_CUTOFF_PHASE_POSE_ERROR_MULTI);
g.loadMarker(C+"solar.patt")};K.load(C+"camera_para.dat")});b4w.require("AR_main").init();
