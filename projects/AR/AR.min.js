b4w.register("AR_main",function(ba,d){function ca(c,a){a?(N.create_preloader(),c.oncontextmenu=function(a){a.preventDefault();a.stopPropagation();return!1},da.load(D+"AR.json",ea,fa)):console.log("b4w init failure")}function fa(c){N.update_preloader(c)}function ea(c,a){var b=document.getElementById("switch_stereo");b.textContent=v?"Disable side-by-side rendering":"Enable side-by-side rendering";b.addEventListener("click",function(){E.set("stereo",!v);window.location.reload()});b.style.display="";
navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(O)["catch"](F):F(Error("WebRTC: It seems WebRTC is not supported on your device."));var d=z.get_container();d.addEventListener("click",function(){ha.request_fullscreen(d)});b=document.getElementById("switch_video");b.style.display=v?"none":"";var w=document.getElementById("v");w.style.display=v?"none":"";b.addEventListener("click",function(){var a=!0;return function(){a=!a;w.style.display=a?"":"none";P(!a)}}());document.querySelector(".control").style.display=
G.is_ie11()?"block":"grid";if(a){Q.enable_camera_controls();ia();h={front:e.get_object_by_name("orbits_front"),back:e.get_object_by_name("orbits_back"),start_scale:1,start_time:-Infinity};ja();var b=l.create_mouse_click_sensor(),m=l.create_touch_click_sensor(),t=l.create_timeline_sensor();l.create_sensor_manifold(null,"TRIG_ANIMATION",l.CT_SHOT,[b,m,t],function(a){return a[0]||a[1]},function(a,b,c){var f=l.get_sensor_value(a,b,0),d=l.get_sensor_value(a,b,1);c=l.get_sensor_value(a,b,2);if(f||d)if(a=
f?l.get_sensor_payload(a,b,0):l.get_sensor_payload(a,b,1),a=z.client_to_canvas_coords(a.coords[0],a.coords[1],ka),a=e.pick_object(a[0],a[1])){a:{for(b=0;b<p.length;b++)if(f=p[b],f.geom===a){b=f;break a}b=null}if(b)for(u=b.focused?!1:!0,n.start_time=c,b=g.get_translation_rel(n.geom,q),n.start_trans_length=k.length(b),h.start_time=c,h.start_scale=g.get_scale(h.front),b=0;b<p.length;b++)f=p[b],d=g.get_translation_rel(f.armature,q),u?(k.copy(d,f.original_trans),f.focused=f.geom==a?!0:!1):f.focused=!1,
f.start_scale=g.get_scale(f.armature),f.start_time=c,f.start_trans_length=k.length(d)}});t=l.create_timeline_sensor();l.create_sensor_manifold(null,"ANIMATION",l.CT_POSITIVE,[t],null,function(a,b,c){a=l.get_sensor_value(a,b,0);c=a-n.start_time;1>=c&&(b=k.copy(G.AXIS_X,q),c=u?r.ease_out_expo(c,n.start_trans_length,50,1):r.ease_out_expo(c,n.start_trans_length,-n.start_trans_length,1),b=k.scale(b,c,q),b=k.add(b,n.origin_trans,b),g.set_translation_rel_v(n.geom,b),g.set_translation_rel_v(n.crown_geom,
b),g.set_translation_rel_v(n.lamp,b));u&&(H=!1);for(b=0;b<p.length;b++){c=p[b];var d=a-c.start_time;if(1>=d){var w,f;if(u)c.focused?(w=r.ease_out_bounce(d,c.start_scale,20/(la[c.name]*I[c.name]),1),d=r.ease_out_expo(d,c.start_trans_length,-c.start_trans_length,1)):(w=r.ease_in_circ(d,c.start_scale,-c.start_scale,1),d=r.ease_in_expo(d,c.start_trans_length,500,1)),f=k.normalize(c.original_trans,q),f=k.scale(f,d,q),R.stop(c.empty);else{w=r.ease_out_expo(d,c.start_scale,I[c.name]-c.start_scale,1);f=k.normalize(c.original_trans,
q);var ga=k.length(c.original_trans),d=r.ease_out_expo(d,c.start_trans_length,ga-c.start_trans_length,1);f=k.scale(f,d,q)}g.set_translation_rel_v(c.armature,f);g.set_scale(c.armature,w)}else if(u)for(b=0;b<p.length;b++)c=p[b],c.focused||g.set_scale(c.armature,0);else if(!H)for(b=0;b<p.length;b++)c=p[b],g.set_translation_rel_v(c.armature,c.original_trans),R.play(c.empty),H=!0}a-=h.start_time;1>=a?(u?a=r.ease_in_expo(a,h.start_scale,50,1):(e.is_hidden(h.front)&&(e.show_object(h.front),e.show_object(h.back)),
a=r.ease_out_expo(a,h.start_scale,1-h.start_scale,1)),g.set_scale(h.front,a),g.set_scale(h.back,a)):u?e.is_hidden(h.front)||(e.hide_object(h.front),e.hide_object(h.back)):(g.set_scale(h.front,1),g.set_scale(h.back,1))})}else console.log("b4w load failure")}function ja(){var c=e.get_object_by_name("Sun_geom");n={geom:e.get_object_by_name("Sun_geom"),crown_geom:e.get_object_by_name("Sun_crown_geom"),lamp:e.get_object_by_name("Lamp"),start_time:-Infinity,start_trans_length:0,origin_trans:g.get_translation_rel(c,
new Float32Array(3))}}function ia(){for(var c=0;c<S.length;c++){var a;a=S[c];a={name:a,empty:e.get_object_by_name(a+"_Emty"),geom:e.get_object_by_name(a+"_geom"),empty_action:a+"_EmtyAction",geom_action:a+"_ArmatureAction",armature:e.get_object_by_name(a+"_Armature"),focused:!1,start_time:-Infinity,start_scale:1,original_trans:new Float32Array(3),start_trans_length:1};g.set_scale(a.armature,I[a.name]);p.push(a)}}function O(c){for(var a=document.querySelector("select#video_source");a.firstChild;)a.removeChild(a.firstChild);
if(!c.length)throw Error("Camera devices are unavailable. Try to plug in your Web camera. If the camera is actually present, try closing any other tabs which use the camera, and reboot the current tab.");for(var b=0;b!==c.length;++b){var d=c[b];if("videoinput"===d.kind){var e=document.createElement("option");e.value=d.deviceId;e.text=d.label||"Camera "+(a.length+1);a.appendChild(e)}}J.set_render_callback(ma)}function F(c){var a=e.get_active_camera();T.target_setup(a,{pos:na,pivot:U,use_panning:!0});
window.removeEventListener("resize",K);window.addEventListener("resize",V);V();a=e.get_object_by_name("Empty");e.show_object(a);g.set_translation_v(a,U);J.clear_render_callback();if(a=document.getElementById("error"))a.style.display=G.is_ie11()?"block":"grid","DevicesNotFoundError"==c.name?a.textContent="Camera devices are unavailable. Try to plug in your Web camera. If the camera is actually present, try closing any other tabs which use the camera, and reboot the current tab.":"TrackStartError"==
c.name?(a.textContent="Media devices are unavailable.",a.textContent+=" Try to close another program using Web camera."):a.textContent="Error: "+c.name+" "+c.message}function oa(c){window.stream=c;A.srcObject=c;return navigator.mediaDevices.enumerateDevices()}function W(){window.stream&&window.stream.getTracks().forEach(function(a){a.stop()});var c=document.querySelector("select#video_source");c.onchange=W;c=c.value;navigator.mediaDevices.getUserMedia({video:{deviceId:c?{exact:c}:void 0}}).then(oa).then(O).then(X)["catch"](F)}
function ma(){X();window.addEventListener("resize",K);A||(A=document.getElementById("v"),W());var c=e.get_object_by_name("Empty");m.detectMarker(A);if(0<m.getMarkerNum())if(-Infinity===B)B=performance.now();else{if(100<performance.now()-B){L?(m.getTransMatSquareCont(0,1,x,x),e.is_hidden(c)&&e.show_object(c)):m.getTransMatSquare(0,1,x);m.getTransMatSquare(0,1,x);var a=m.transMatToGLMat(x,y);if(J.detect_mobile()&&-1<navigator.userAgent.indexOf("Firefox")){var b=y;b[0]=a[0];b[1]=-a[1];b[2]=a[2];b[3]=
a[3];b[4]=-a[4];b[5]=a[5];b[6]=-a[6];b[7]=-a[7];b[8]=a[8];b[9]=-a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=-a[13];b[14]=a[14];b[15]=a[15];a=b}b=t.fromXRotation(-Math.PI,pa);a=t.multiply(b,a,y);a=C.from_mat4(a,qa);b=C.get_trans_view(a,q);b=k.scale(b,20,q);C.set_trans(b,a);g.set_tsr(c,a);L=!0}}else e.hide_object(c),L=!1,B=-Infinity}function X(){m&&(K(),Y||(P(v),Y=!0))}function P(c){Z=m.getCameraMatrix();var a=e.get_active_camera(),b=t.fromXRotation(-Math.PI,y),b=t.multiply(Z,b,y);if(c){var d=t.invert(b,
new Float32Array(16));c=k.transformMat4([-1,-1,-1],d,[]);b=k.transformMat4([1,1,-1],d,[]);d=k.transformMat4([1,1,1],d,[]);b=t.frustum(.5*c[0],.5*b[0],.5*c[1],.5*b[1],-c[2],-d[2],[])}T.set_projection(a,b)}function V(){z.resize_to_container(!0)}function K(){var c=document.getElementById("v"),a=z.get_canvas();if(c&&a){var b=window.innerWidth,d=window.innerHeight,e=c.videoWidth/c.videoHeight;b/d<e?(e*=d,a.style.width=e+"px",a.style.marginLeft=-(e-b)/2+"px",a.style.height=d+"px",a.style.marginTop="0px"):
(e=1/(e/b),a.style.height=e+"px",a.style.marginTop=-(e-d)/2+"px",a.style.width=b+"px",a.style.marginLeft="0px");c.style.width=a.style.width;c.style.height=a.style.height;c.style.marginLeft=a.style.marginLeft;c.style.marginTop=a.style.marginTop}}var R=d("animation"),Q=d("app"),T=d("camera"),ra=d("config"),z=d("container"),l=d("controls"),da=d("data"),J=d("main"),t=d("mat4"),r=d("math"),N=d("preloader"),C=d("tsr"),e=d("scenes"),ha=d("screen"),E=d("storage"),g=d("transform"),G=d("util"),sa=d("version"),
k=d("vec3");d("vec4");var qa=C.create(),ka=new Float32Array(2),q=k.create(),x=new Float64Array(12),y=new Float32Array(16),pa=new Float32Array(16),U=new Float32Array([0,0,0]),na=new Float32Array([30,30,30]),aa="DEBUG"==sa.type(),D=ra.get_std_assets_path()+"AR/",m=null,A=null,L=!1,B=-Infinity,v=!1,Y=!1,S="Earth Jupiter Mars Mercury Neptune Saturn Uranus Venus".split(" "),la={Mercury:.964,Venus:1.845,Earth:2,Mars:1.374,Jupiter:8.439,Saturn:5.539,Uranus:3.986,Neptune:3.995},I={Mercury:2,Venus:1.5,Earth:1.5,
Mars:1.7,Jupiter:1,Saturn:1,Uranus:1,Neptune:1},p=[],u=!1,n=null,h=null,H=!0;ba.init=function(){E.init("b4w_epson_vr");v="true"===E.get("stereo");Q.init({canvas_container_id:"main_canvas_container",callback:ca,show_fps:aa,console_verbose:aa,autoresize:!1,stereo:v?"SIDEBYSIDE":"NONE"})};var M=new ARCameraParam,Z=null;M.onload=function(){m=new ARController(320,240,M);m.setThreshold(100);m.setPatternDetectionMode(artoolkit.AR_MARKER_INFO_CUTOFF_PHASE_POSE_ERROR_MULTI);m.loadMarker(D+"solar.patt")};M.load(D+
"camera_para.dat")});b4w.require("AR_main").init();
