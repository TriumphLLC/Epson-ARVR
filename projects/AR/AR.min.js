b4w.register("AR_main",function(aa,d){function ba(c,a){a?(M.create_preloader(),c.oncontextmenu=function(a){a.preventDefault();a.stopPropagation();return!1},ca.load(C+"AR.json",da,ea)):console.log("b4w init failure")}function ea(c){M.update_preloader(c)}function da(c,a){var b=document.getElementById("switch_stereo");b.textContent=u?"Disable side-by-side rendering":"Enable side-by-side rendering";b.addEventListener("click",function(){D.set("stereo",!u);window.location.reload()});b.style.display="";
navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(N)["catch"](E):E(Error("WebRTC: It seems WebRTC is not supported on your device."));var d=y.get_container();d.addEventListener("click",function(){ga.request_fullscreen(d)});b=document.getElementById("switch_video");b.style.display=u?"none":"";b.addEventListener("click",function(){var a=!0,b=document.getElementById("v");return function(){a=!a;b.style.display=a?"":"none";O(!a)}}());document.querySelector(".control").style.display=
F.is_ie11()?"block":"grid";if(a){P.enable_camera_controls();ha();k={front:e.get_object_by_name("orbits_front"),back:e.get_object_by_name("orbits_back"),start_scale:1,start_time:-Infinity};ia();var b=m.create_mouse_click_sensor(),ja=m.create_touch_click_sensor(),g=m.create_timeline_sensor();m.create_sensor_manifold(null,"TRIG_ANIMATION",m.CT_SHOT,[b,ja,g],function(a){return a[0]||a[1]},function(a,b,c){var f=m.get_sensor_value(a,b,0),d=m.get_sensor_value(a,b,1);c=m.get_sensor_value(a,b,2);if(f||d)if(a=
f?m.get_sensor_payload(a,b,0):m.get_sensor_payload(a,b,1),a=y.client_to_canvas_coords(a.coords[0],a.coords[1],ka),a=e.pick_object(a[0],a[1])){a:{for(b=0;b<p.length;b++)if(f=p[b],f.geom===a){b=f;break a}b=null}if(b)for(t=b.focused?!1:!0,n.start_time=c,b=h.get_translation_rel(n.geom,q),n.start_trans_length=l.length(b),k.start_time=c,k.start_scale=h.get_scale(k.front),b=0;b<p.length;b++)f=p[b],d=h.get_translation_rel(f.armature,q),t?(l.copy(d,f.original_trans),f.focused=f.geom==a?!0:!1):f.focused=!1,
f.start_scale=h.get_scale(f.armature),f.start_time=c,f.start_trans_length=l.length(d)}});g=m.create_timeline_sensor();m.create_sensor_manifold(null,"ANIMATION",m.CT_POSITIVE,[g],null,function(a,b,c){a=m.get_sensor_value(a,b,0);c=a-n.start_time;1>=c&&(b=l.copy(F.AXIS_X,q),c=t?r.ease_out_expo(c,n.start_trans_length,50,1):r.ease_out_expo(c,n.start_trans_length,-n.start_trans_length,1),b=l.scale(b,c,q),b=l.add(b,n.origin_trans,b),h.set_translation_rel_v(n.geom,b),h.set_translation_rel_v(n.crown_geom,
b),h.set_translation_rel_v(n.lamp,b));t&&(G=!1);for(b=0;b<p.length;b++){c=p[b];var d=a-c.start_time;if(1>=d){var g,f;if(t)c.focused?(g=r.ease_out_bounce(d,c.start_scale,20/(la[c.name]*H[c.name]),1),d=r.ease_out_expo(d,c.start_trans_length,-c.start_trans_length,1)):(g=r.ease_in_circ(d,c.start_scale,-c.start_scale,1),d=r.ease_in_expo(d,c.start_trans_length,500,1)),f=l.normalize(c.original_trans,q),f=l.scale(f,d,q),Q.stop(c.empty);else{g=r.ease_out_expo(d,c.start_scale,H[c.name]-c.start_scale,1);f=l.normalize(c.original_trans,
q);var fa=l.length(c.original_trans),d=r.ease_out_expo(d,c.start_trans_length,fa-c.start_trans_length,1);f=l.scale(f,d,q)}h.set_translation_rel_v(c.armature,f);h.set_scale(c.armature,g)}else if(t)for(b=0;b<p.length;b++)c=p[b],c.focused||h.set_scale(c.armature,0);else if(!G)for(b=0;b<p.length;b++)c=p[b],h.set_translation_rel_v(c.armature,c.original_trans),Q.play(c.empty),G=!0}a-=k.start_time;1>=a?(t?a=r.ease_in_expo(a,k.start_scale,50,1):(e.is_hidden(k.front)&&(e.show_object(k.front),e.show_object(k.back)),
a=r.ease_out_expo(a,k.start_scale,1-k.start_scale,1)),h.set_scale(k.front,a),h.set_scale(k.back,a)):t?e.is_hidden(k.front)||(e.hide_object(k.front),e.hide_object(k.back)):(h.set_scale(k.front,1),h.set_scale(k.back,1))})}else console.log("b4w load failure")}function ia(){var c=e.get_object_by_name("Sun_geom");n={geom:e.get_object_by_name("Sun_geom"),crown_geom:e.get_object_by_name("Sun_crown_geom"),lamp:e.get_object_by_name("Lamp"),start_time:-Infinity,start_trans_length:0,origin_trans:h.get_translation_rel(c,
new Float32Array(3))}}function ha(){for(var c=0;c<R.length;c++){var a;a=R[c];a={name:a,empty:e.get_object_by_name(a+"_Emty"),geom:e.get_object_by_name(a+"_geom"),empty_action:a+"_EmtyAction",geom_action:a+"_ArmatureAction",armature:e.get_object_by_name(a+"_Armature"),focused:!1,start_time:-Infinity,start_scale:1,original_trans:new Float32Array(3),start_trans_length:1};h.set_scale(a.armature,H[a.name]);p.push(a)}}function N(c){for(var a=document.querySelector("select#video_source");a.firstChild;)a.removeChild(a.firstChild);
if(!c.length)throw Error("Camera devices are unavailable. Try to plug in your Web camera. If the camera is actually present, try closing any other tabs which use the camera, and reboot the current tab.");for(var b=0;b!==c.length;++b){var d=c[b];if("videoinput"===d.kind){var e=document.createElement("option");e.value=d.deviceId;e.text=d.label||"Camera "+(a.length+1);a.appendChild(e)}}I.set_render_callback(ma)}function E(c){var a=e.get_active_camera();S.target_setup(a,{pos:na,pivot:T,use_panning:!0});
window.removeEventListener("resize",J);window.addEventListener("resize",U);U();a=e.get_object_by_name("Empty");e.show_object(a);h.set_translation_v(a,T);I.clear_render_callback();if(a=document.getElementById("error"))a.style.display=F.is_ie11()?"block":"grid","DevicesNotFoundError"==c.name?a.textContent="Camera devices are unavailable. Try to plug in your Web camera. If the camera is actually present, try closing any other tabs which use the camera, and reboot the current tab.":"TrackStartError"==
c.name?(a.textContent="Media devices are unavailable.",a.textContent+=" Try to close another program using Web camera."):a.textContent="Error: "+c.name+" "+c.message}function oa(c){window.stream=c;z.srcObject=c;return navigator.mediaDevices.enumerateDevices()}function V(){window.stream&&window.stream.getTracks().forEach(function(a){a.stop()});var c=document.querySelector("select#video_source");c.onchange=V;c=c.value;navigator.mediaDevices.getUserMedia({video:{deviceId:c?{exact:c}:void 0}}).then(oa).then(N).then(W)["catch"](E)}
function ma(){W();window.addEventListener("resize",J);z||(z=document.getElementById("v"),V());var c=e.get_object_by_name("Empty");g.detectMarker(z);if(0<g.getMarkerNum())if(-Infinity===A)A=performance.now();else{if(100<performance.now()-A){K?(g.getTransMatSquareCont(0,1,w,w),e.is_hidden(c)&&e.show_object(c)):g.getTransMatSquare(0,1,w);g.getTransMatSquare(0,1,w);var a=g.transMatToGLMat(w,x);if(I.detect_mobile()&&-1<navigator.userAgent.indexOf("Firefox")){var b=x;b[0]=a[0];b[1]=-a[1];b[2]=a[2];b[3]=
a[3];b[4]=-a[4];b[5]=a[5];b[6]=-a[6];b[7]=-a[7];b[8]=a[8];b[9]=-a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=-a[13];b[14]=a[14];b[15]=a[15];a=b}b=v.fromXRotation(-Math.PI,pa);a=v.multiply(b,a,x);a=B.from_mat4(a,qa);b=B.get_trans_view(a,q);b=l.scale(b,20,q);B.set_trans(b,a);h.set_tsr(c,a);K=!0}}else e.hide_object(c),K=!1,A=-Infinity}function W(){g&&(J(),X||(O(u),X=!0))}function O(c){Y=g.getCameraMatrix();var a=e.get_active_camera(),b=v.fromXRotation(-Math.PI,x),b=v.multiply(Y,b,x);if(c){var d=v.invert(b,
new Float32Array(16));c=l.transformMat4([-1,-1,-1],d,[]);b=l.transformMat4([1,1,-1],d,[]);d=l.transformMat4([1,1,1],d,[]);b=v.frustum(.5*c[0],.5*b[0],.5*c[1],.5*b[1],-c[2],-d[2],[])}S.set_projection(a,b)}function U(){y.resize_to_container(!0)}function J(){var c=document.getElementById("v"),a=y.get_canvas();if(c&&a){var b=window.innerWidth,d=window.innerHeight,e=c.videoWidth/c.videoHeight;b/d<e?(e*=d,a.style.width=e+"px",a.style.marginLeft=-(e-b)/2+"px",a.style.height=d+"px",a.style.marginTop="0px"):
(e=1/(e/b),a.style.height=e+"px",a.style.marginTop=-(e-d)/2+"px",a.style.width=b+"px",a.style.marginLeft="0px");c.style.width=a.style.width;c.style.height=a.style.height;c.style.marginLeft=a.style.marginLeft;c.style.marginTop=a.style.marginTop}}var Q=d("animation"),P=d("app"),S=d("camera"),ra=d("config"),y=d("container"),m=d("controls"),ca=d("data"),I=d("main"),v=d("mat4"),r=d("math"),M=d("preloader"),B=d("tsr"),e=d("scenes"),ga=d("screen"),D=d("storage"),h=d("transform"),F=d("util"),sa=d("version"),
l=d("vec3");d("vec4");var qa=B.create(),ka=new Float32Array(2),q=l.create(),w=new Float64Array(12),x=new Float32Array(16),pa=new Float32Array(16),T=new Float32Array([0,0,0]),na=new Float32Array([30,30,30]),Z="DEBUG"==sa.type(),C=ra.get_std_assets_path()+"AR/",g=null,z=null,K=!1,A=-Infinity,u=!1,X=!1,R="Earth Jupiter Mars Mercury Neptune Saturn Uranus Venus".split(" "),la={Mercury:.964,Venus:1.845,Earth:2,Mars:1.374,Jupiter:8.439,Saturn:5.539,Uranus:3.986,Neptune:3.995},H={Mercury:2,Venus:1.5,Earth:1.5,
Mars:1.7,Jupiter:1,Saturn:1,Uranus:1,Neptune:1},p=[],t=!1,n=null,k=null,G=!0;aa.init=function(){D.init("b4w_epson_vr");u="true"===D.get("stereo");P.init({canvas_container_id:"main_canvas_container",callback:ba,show_fps:Z,console_verbose:Z,autoresize:!1,stereo:u?"SIDEBYSIDE":"NONE"})};var L=new ARCameraParam,Y=null;L.onload=function(){g=new ARController(320,240,L);g.setThreshold(100);g.setPatternDetectionMode(artoolkit.AR_MARKER_INFO_CUTOFF_PHASE_POSE_ERROR_MULTI);g.loadMarker(C+"solar.patt")};L.load(C+
"camera_para.dat")});b4w.require("AR_main").init();
